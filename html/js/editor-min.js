var ie6=$.browser.msie&&$.browser.version<7;var ColorPicker=function(){var d=this;if(!ColorPicker.instance){d.mask=$('<div class="mask"></div>').appendTo(document.body).css({position:"fixed",top:0,left:0,background:"#000",width:"100%",height:"100%",zIndex:100,opacity:0.5}).hide();d.container=$('<div id="colorpicker"></div>').css({background:"#fff",position:"absolute",border:"1px solid #ccc",fontSize:"12px",zIndex:101}).appendTo(document.body).hide();d.table=$('<table border="0" cellspadding="0" cellspacing="1"></table>').appendTo(d.container);d.colors=["#000000","#a0522d","#556b2f","#006400","#483d8b","#000080","#4b0082","#2f4f4f","#8b0000","#ff8c00","#808000","#008000","#008080","#0000ff","#708090","#696969","#ff0000","#f4a460","#9acd32","#2e8b57","#48d1cc","#4169e1","#800080","#808080","#ff00ff","#ffa500","#ffff00","#00ff00","#00ffff","#00bfff","#9932cc","#c0c0c0","#ffc0cb","#f5deb3","#fffacd","#98fb98","#afeeee","#add8e6","#dda0dd","#ffffff"];for(var c=0;c<5;++c){var e=$("<tr></tr>").appendTo(d.table);for(var b=0;b<8;++b){var a=d.colors[c*8+b];$('<td style="background:'+a+';"></td>').attr("color",a).css({width:"10px",height:"10px",border:"none",cursor:"pointer",padding:0,margin:0}).click(function(g){if($.isFunction(d.func)){d.func.call(d,$(this).attr("color"))}d.hide()}).appendTo(e)}}var f=$('<td colspan="8"></td>').appendTo($("<tr></tr>").appendTo(d.table));$('<a href="javascript:void(0);">Cancel</a>').css({display:"block",textDecoration:"none",color:"#000",background:"#eee",textAlign:"center"}).appendTo(f).click(function(g){d.hide()});ColorPicker.instance=d}return ColorPicker.instance};ColorPicker.prototype={container:$(),table:$(),colors:null,func:function(a){},show:function(b,c){var a=this;a.func=b;if(c){a.container.css(c)}if(!ie6){a.mask.fadeIn("fast")}a.container.slideDown("fast")},hide:function(){this.container.slideUp("fast");if(!ie6){this.mask.fadeOut("fast")}}};var Prompt=function(){var a=this;if(!Prompt.instance){a.mask=$('<div class="mask"></div>').appendTo(document.body).css({position:"fixed",top:0,left:0,background:"#000",width:"100%",height:"100%",zIndex:100,opacity:0.5}).hide();a.container=$('<div id="prompt"></div>').css({background:"#fff",border:"1px solid #ccc",position:"absolute",fontSize:"12px",zIndex:101}).appendTo(document.body).hide();a.title=$("<p></p>").appendTo(a.container).css({margin:"0",padding:"5px 5px 0"});a.txt=$('<input type="text" />').appendTo(a.container).css({width:"400px",display:"block",margin:"5px",clear:"both"}).keypress(function(b){if(b.keyCode==13){a.ok.click()}});a.ok=$('<a href="javascript:void(0);">OK</a>').appendTo(a.container).css({display:"block",cssFloat:"left",margin:"0 5px"}).click(function(){if($.isFunction(a.onOk)){a.onOk.call(a)}a.hide()});a.cancel=$('<a href="javascript:void(0);">Cancel</a>').appendTo(a.container).click(function(){a.hide()})}return Prompt.instance};Prompt.prototype={mask:$(),container:$(),title:$(),txt:$(),ok:$(),cancel:$(),onOk:function(a){},show:function(e,a,c,d){var b=this;b.onOk=c;this.title.html(e||"输入");if(UbbUtils.def(a)){this.txt.val(a)}if(d){b.container.css(d)}if(!ie6){b.mask.fadeIn("fast")}b.container.slideDown("fast")},hide:function(){this.container.slideUp("fast");if(!ie6){this.mask.fadeOut("fast")}}};var UbbEditor=function(a,b){new ColorPicker();this.id=a;this.editorTxt=$("#"+a).addClass("editor-textarea");this.wrapper=this.editorTxt.wrap('<div id="'+a+'-wrapper"></div>').parent("div").addClass("editor-wrapper");this.toolbar=$('<div id="'+a+'-toolbar"></div>').insertBefore(this.editorTxt).addClass("editor-toolbar");this.EditMode=b||UbbEditor.EditMode.Visual;this.initialize();return this};UbbEditor.EditMode={Text:"text",Visual:"visual"};UbbEditor.setDocText=function(a,b){if(!$.browser.msie||!a.initialized){a.designMode="on";a.open("text/html","replace");a.write(b);a.close();a.body.contentEditable=true;a.initialized=true}else{a.body.innerHTML=b}};UbbEditor.showPrompt=function(a,e,b,d){new Prompt().show(a,e,b,d)};UbbEditor.readNodes=function(d,j){switch(d.nodeType){case Node.ELEMENT_NODE:case Node.DOCUMENT_FRAGMENT_NODE:var h=/_moz/i,g="",e;if(j){e=!d.hasChildNodes();g="<"+d.tagName.toLowerCase();var b=d.attributes;for(var f=0;f<b.length;++f){var c=b.item(f);if(!c.specified||c.name.match(h)||c.value.match(h)){continue}g+=" "+c.name.toLowerCase()+'="'+c.value+'"'}g+=e?" />":">"}for(var f=d.firstChild;f;f=f.nextSibling){g+=UbbEditor.readNodes(f,true)}if(j&&!e){g+="</"+d.tagName.toLowerCase()+">"}return g;case Node.TEXT_NODE:return d.data}};UbbEditor.removeFormat=function(c){var b=c.data.editor,a=b.domDoc;b.execCommand("removeformat",false,false)};UbbEditor.makeBold=function(f){var d=f.data.editor,g=d.getSelection(),b=d.domDoc,a=d.EditMode;var c=d.wrapTag(g,["[b]","<strong>"],["[/b]","</strong>"]);if(a==UbbEditor.EditMode.Text){d.insertText(c)}else{d.execCommand("bold",false,false)}};UbbEditor.makeItalic=function(f){var c=f.data.editor,g=c.getSelection(),b=c.domDoc,a=c.EditMode;var d=c.wrapTag(g,["[i]","<em>"],["[/i]","</em>"]);if(a==UbbEditor.EditMode.Text){c.insertText(d)}else{c.execCommand("italic",false,false)}};UbbEditor.makeSize=function(g){var d=$(this),c=g.data.editor,h=c.getSelection(),f=$(g.target).offset(),b=c.domDoc,a=c.EditMode;f.top+=d.height();UbbEditor.showPrompt("输入大小（1~7之间）","4",function(){var i=UbbUtils.range(this.txt.val(),1,7,4);var e=c.wrapTag(h,["[size="+i+"]",'<font size="'+i+'">'],["[/size]","</font>"]);if(a==UbbEditor.EditMode.Text){c.insertText(e)}else{c.execCommand("fontsize",false,i)}},f)};UbbEditor.makeColor=function(h){var f=$(this),c=h.data.editor,i=c.getSelection(),d=c.domWin,g=$(h.target).offset(),b=c.domDoc,a=c.EditMode;g.top+=f.height();new ColorPicker().show(function(j){var e=c.wrapTag(i,["[color="+j+"]",'<font style="color:'+j+';">'],["[/color]","</font>"]);if(a==UbbEditor.EditMode.Text){c.insertText(e)}else{c.execCommand("forecolor",false,j)}},g)};UbbEditor.makeLink=function(d){var b=$(this),a=d.data.editor,f=a.getSelection(),c=$(d.target).offset();c.top+=b.height();UbbEditor.showPrompt("输入地址","http://",function(){var e=this.txt.val();var g=a.wrapTag(f,["[url="+e+"]",'<a href="'+e+'" target="_blank">'],["[/url]","</a>"]);a.insertText(g)},c)};UbbEditor.unlink=function(d){var c=d.data.editor,f=c.getSelection(),b=c.domDoc,a=c.EditMode;c.execCommand("unlink",false,false)};UbbEditor.makeImage=function(f){var c=$(this),b=f.data.editor,a=b.EditMode,g=b.getSelection(),d=$(f.target).offset();d.top+=c.height();UbbEditor.showPrompt("输入图片地址","http://",function(){var h=this.txt.val();var e=a==UbbEditor.EditMode.Visual?('<img src="'+h+'" />'):("[img="+h+"]");b.insertText(e)},d)};UbbEditor.copyToClipboard=function(f,k,d){var l=window;var j=function(){if($.isFunction(d)){d.call()}};if(l.clipboardData){l.clipboardData.clearData();l.clipboardData.setData("Text",f);if($.isFunction(k)){k.call()}return}else{if($.browser.opera){l.location=f;if($.isFunction(k)){k.call()}return}else{if($.browser.mozilla){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect")}catch(h){return j()}var c=Components.classes["@mozilla.org/widget/clipboard;1"].createInstance(Components.interfaces.nsIClipboard);if(!c){return j()}var m=Components.classes["@mozilla.org/widget/transferable;1"].createInstance(Components.interfaces.nsITransferable);if(!m){return j()}m.addDataFlavor("text/unicode");var g=new Object(),i=Components.classes["@mozilla.org/supports-string;1"].createInstance(Components.interfaces.nsISupportsString);var b=f;i.data=b;m.setTransferData("text/unicode",i,b.length*2);var a=Components.interfaces.nsIClipboard;if(!c){return j()}c.setData(m,null,a.kGlobalClipboard);if($.isFunction(k)){k.call()}return}}}return j()};UbbEditor.prototype={initialize:function(){var a=this;a.setEditorArea();a.initializeComponents();a.setEditorContent();a.setEditorStyle();a.setEditorEvents()},setEditorArea:function(){var a=this,b=this.id+"-frame";a.editorFrm=$('<iframe id="'+b+'" class="editor-frame"></iframe>');a.editorTxt.after(a.editorFrm);a.domWin=a.editorFrm.attr("contentWindow");a.domDoc=a.domWin.document;if(a.EditMode==UbbEditor.EditMode.Visual){a.editorTxt.hide()}else{a.editorFrm.hide()}},makeButton:function(a,b){return $('<a href="javascript:void(0);" title="'+b+'" class="editor-button editor-'+a+'">'+b+"</a>").appendTo(this.toolbar)},initializeComponents:function(){var a=this;a.btnToggle=a.makeButton("btnToggle","切换模式");a.btnRemoveFormat=a.makeButton("btnRemoveFormat","移除格式");a.btnBold=a.makeButton("btnBold","粗体");a.btnItalic=a.makeButton("btnItalic","斜体");a.btnSize=a.makeButton("btnSize","字号");a.btnColor=a.makeButton("btnColor","颜色");a.btnLink=a.makeButton("btnLink","超链接");a.btnUnlink=a.makeButton("btnUnlink","取消链接");a.btnImage=a.makeButton("btnImage","插入图片")},setEditorContent:function(){var b=this,a=b.editorTxt;a.val($.trim(a.val()));if(b.EditMode==UbbEditor.EditMode.Visual){UbbEditor.setDocText(b.domDoc,UbbUtils.ubb2Html(a.val()))}},setEditorStyle:function(){var e=this,a=e.domDoc,f=document;if($.browser.msie){for(var c=0;c<f.styleSheets.length;++c){a.createStyleSheet().cssText=f.styleSheets[c].cssText;a.body.className="editor-body"}}else{for(var b=0;b<f.styleSheets.length;b++){if(f.styleSheets[b].cssRules.length<=0){continue}for(var c=0;c<f.styleSheets[b].cssRules.length;c++){if(f.styleSheets[b].cssRules[c].selectorText==".editor-body"){$('<style type="text/css"></style>').html(f.styleSheets[b].cssRules[c].cssText).appendTo(a.documentElement.childNodes[0])}}}$(a.body).css("fontSize",$(f.body).css("fontSize"));$(a.body).css("fontFamily",$(f.body).css("fontFamily"))}},bindClick:function(b,a){b.bind("click",{editor:this},a)},setEditorEvents:function(){var a=this;this.editorTxt.parents("form").bind("submit",{},function(){if(a.EditMode==UbbEditor.EditMode.Visual){a.editorTxt.val(a.getUbbValue())}});if($.browser.msie){$(a.domDoc).keydown(function(c){if(c.keyCode!=13){return}var b=this.selection.createRange();b.text="\n";b.select();return false})}a.bindClick(a.btnToggle,function(b){b.data.editor.toggleStyle()});a.bindClick(a.btnRemoveFormat,UbbEditor.removeFormat);a.bindClick(a.btnBold,UbbEditor.makeBold);a.bindClick(a.btnItalic,UbbEditor.makeItalic);a.bindClick(a.btnSize,UbbEditor.makeSize);a.bindClick(a.btnColor,UbbEditor.makeColor);a.bindClick(a.btnLink,UbbEditor.makeLink);a.bindClick(a.btnUnlink,UbbEditor.unlink);a.bindClick(a.btnImage,UbbEditor.makeImage)},toggleText:function(){var b=this,a=b.domDoc;if(b.EditMode==UbbEditor.EditMode.Visual){b.editorTxt.val(UbbUtils.html2Ubb(a.body.innerHTML))}else{UbbEditor.setDocText(a,UbbUtils.ubb2Html(b.editorTxt.val()))}},toggleStyle:function(){var d=this,b=d.EditMode,a=d.editorFrm,c=d.editorTxt;d.toggleText();if(b==UbbEditor.EditMode.Visual){a.hide();c.show().focus();d.EditMode=UbbEditor.EditMode.Text}else{c.hide();a.show().focus();d.EditMode=UbbEditor.EditMode.Visual}},getValue:function(){var a=this;return a.EditMode==UbbEditor.EditMode.Text?a.editorTxt.val():a.domDoc.body.innerHTML},getUbbValue:function(){var a=this;return a.EditMode==UbbEditor.EditMode.Text?a.editorTxt.val():UbbUtils.html2Ubb(a.domDoc.body.innerHTML)},getHtmlValue:function(){var a=this;return a.EditMode==UbbEditor.EditMode.Text?UbbUtils.ubb2Html(a.editorTxt.val()):a.domDoc.body.innerHTML},getSelection:function(){var l=this,j=window,f=document,k=l.domDoc,a=l.domWin,g=l.editorTxt.get(0);if(this.EditMode==UbbEditor.EditMode.Text){if(UbbUtils.def(g.selectionStart)){return g.value.substr(g.selectionStart,g.selectionEnd-g.selectionStart)}else{if(f.selection&&f.selection.createRange){return f.selection.createRange().text}else{if(j.getSelection){return window.getSelection()+""}}}return null}else{if(a.getSelection){var h=l.selection=l.domWin.getSelection();var e=l.range=h?h.getRangeAt(0):k.createRange();return UbbEditor.readNodes(e.cloneContents(),false)}else{l.selection=k.selection;var e=l.range=k.selection.createRange();if(e.htmlText&&e.text){return e.htmlText}var c="";for(var b=0;b<e.length;++b){c+=e.item(b).outerHTML}return c}}},wrapTag:function(c,d,b){var a=this.EditMode;if(a==UbbEditor.EditMode.Text){return(d[0]+c+b[0])}return(d[1]+c+b[1])},insertNodeAtSelection:function(n){var o=this,i=document,l=window,m=o.domDoc,a=o.domWin;var b=a.getSelection();var f=b?b.getRangeAt(0):m.createRange();b.removeAllRanges();f.deleteContents();var c=f.startContainer,j=f.startOffset,h=n.nodeType,e=null;var k=function(q){var d=a.getSelection(),p=m.createRange();p.selectNodeContents(q);d.removeAllRanges();d.addRange(p)};switch(c.nodeType){case Node.ELEMENT_NODE:if(h==Node.DOCUMENT_FRAGMENT_NODE){e=n.firstChild}else{e=n}c.insertBefore(n,c.childNodes[j]);k(e);break;case Node.TEXT_NODE:if(h==Node.TEXT_NODE){var g=j+n.length;c.insertData(j,n.data);f=m.createRange();f.setEnd(c,g);f.setStart(c,g);b.addRange(f)}else{c=c.splitText(j);if(h==Node.DOCUMENT_FRAGMENT_NODE){e=n.firstChild}else{e=n}c.parentNode.insertBefore(n,c);k(e)}break}},insertText:function(l){var n=this,i=document,e=n.EditMode,j=n.editorTxt.get(0),k=n.domDoc,a=n.domWin;if(e==UbbEditor.EditMode.Visual){if(a.getSelection){var h=k.createDocumentFragment(),f=k.createElement("span");f.innerHTML=l;while(f.firstChild){h.appendChild(f.firstChild)}n.insertNodeAtSelection(h)}else{var c=n.selection;var g=n.range;g.pasteHTML(l)}}else{if(UbbUtils.def(j.selectionStart)){var b=j.selectionStart+0;j.value=j.value.substr(0,j.selectionStart)+l+j.value.substr(j.selectionEnd)}else{if(i.selection&&i.selection.createRange){var g=i.selection.createRange();g.text=l.replace(/\r?\n/g,"\r\n");g.select()}else{j.value+=l}}}},execCommand:function(g,c,h){var e=this,f=e.selection,d=e.range,a=this.domDoc;if($.browser.msie&&g!="removeformat"&&f&&d){d.execCommand(g,c,h)}else{a.execCommand(g,c,h)}}};